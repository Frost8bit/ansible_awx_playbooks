- name: Send IUN notification
  hosts: localhost
  gather_facts: no

  vars:

  tasks:
    - name: Check if 'notification' variable is defined and not empty
      fail:
        msg: "'notification' variable is not defined or empty"
      when: notification is undefined or notification | trim == ""

    - name: Check if 'ticket_id' variable is defined and not empty
      fail:
        msg: "'ticket_id' variable is not defined or empty"
      when: ticket_id is undefined or ticket_id | trim == ""

    - name: Add a reply to the ticket in RT
      set_fact:
        rt_ticket_id: "{{ ticket_id | regex_replace('^TT', '') }}"
      uri:
        url: "https://rt4.int.portaone.com/REST/1.0/ticket/{{ rt_ticket_id }}/comment"
        method: POST
        validate_certs: no
        body_format: form-urlencoded
        body:
          user: "{{ rt_login }}"
          pass: "{{ rt_password }}"
          content: "id: {{ rt_ticket_id }}\nAction: correspond\nText: {{ notification }}"
        headers:
          Content-Type: "application/x-www-form-urlencoded"
      register: response
      when: ticket_id is match("^TT[0-9]{1,6}$")

    - name: Check response from RT
      debug:
        var: response
      when: ticket_id is match("^TT[0-9]{1,6}$")

    - name: Add a reply to the ticket in YT
      debug:
        msg: "This is a placeholder for YouTrack notification to ticket_id: {{ ticket_id }}"
      when: ticket_id is match("^CSUP-[0-9]+$")

